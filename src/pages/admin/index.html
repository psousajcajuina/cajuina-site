<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <link href="/admin/collections/posts.yml" type="text/yaml" rel="cms-config-url" />
    <link href="/admin/collections/products.yml" type="text/yaml" rel="cms-config-url" />
    <link href="/admin/config.yml" type="text/yaml" rel="cms-config-url" />
    <title>Cajuina Blog CMS</title>
    <style>
        .geocode-button {
            margin: 8px 0;
            padding: 10px 20px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            max-width: 400px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .geocode-button:hover {
            background-color: #1565c0;
        }
        .geocode-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .geocode-status {
            margin: 8px 0;
            padding: 8px;
            border-radius: 4px;
            font-size: 13px;
        }
        .geocode-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .geocode-error {
            background-color: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <script src="https://unpkg.com/@sveltia/cms/dist/sveltia-cms.js"></script>
    <script>
        // Esperar o CMS carregar completamente
        window.addEventListener('load', function() {
            setTimeout(function() {
                initGeocoding();
                
                // Observar mudan√ßas para adicionar o bot√£o quando necess√°rio
                const observer = new MutationObserver(function() {
                    addGeocodeButton();
                });

                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            }, 3000);
        });

        function initGeocoding() {
            addGeocodeButton();
        }

        function addGeocodeButton() {
            // Buscar a section do campo de endere√ßo
            const enderecoSection = document.querySelector('section[data-key-path="endereco"]');
            
            if (!enderecoSection) return;
            
            // Verificar se o bot√£o j√° existe
            const existingButton = enderecoSection.nextElementSibling?.querySelector?.('.geocode-button');
            if (existingButton) return;

            // Buscar o input de endere√ßo
            const enderecoInput = enderecoSection.querySelector('input[type="text"]');
            if (!enderecoInput) return;

            // Criar container para o bot√£o
            const buttonContainer = document.createElement('div');
            buttonContainer.style.marginTop = '12px';
            buttonContainer.style.marginBottom = '16px';
            buttonContainer.style.padding = '0 16px';
            buttonContainer.style.width = '100%';
            buttonContainer.style.display = 'flex';
            buttonContainer.style.flexDirection = 'column';
            buttonContainer.style.alignItems = 'center';
            
            // Criar bot√£o
            const button = document.createElement('button');
            button.className = 'geocode-button';
            button.textContent = 'üåç Buscar Coordenadas Automaticamente';
            button.type = 'button';
            
            // Criar div para status
            const statusDiv = document.createElement('div');
            statusDiv.className = 'geocode-status';
            statusDiv.style.display = 'none';
            
            button.addEventListener('click', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const endereco = enderecoInput.value;
                
                if (!endereco) {
                    showStatus('‚ö†Ô∏è Por favor, preencha o endere√ßo primeiro.', 'error');
                    return;
                }
                
                button.disabled = true;
                button.textContent = 'üîÑ Buscando...';
                statusDiv.style.display = 'none';
                
                try {
                    const query = encodeURIComponent(endereco);
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const { lat, lon } = data[0];
                        
                        console.log('Coordenadas obtidas da API:', { lat, lon });
                        
                        // Estrat√©gia 1: Buscar por data-key-path
                        let latSection = document.querySelector('section[data-key-path="lat"]');
                        let lngSection = document.querySelector('section[data-key-path="lng"]');
                        
                        let latInput = null;
                        let lngInput = null;
                        
                        if (latSection && lngSection) {
                            latInput = latSection.querySelector('input');
                            lngInput = lngSection.querySelector('input');
                        }
                        
                        // Estrat√©gia 2: Buscar por data-typed-key-path
                        if (!latInput || !lngInput) {
                            latSection = document.querySelector('section[data-typed-key-path="lat"]');
                            lngSection = document.querySelector('section[data-typed-key-path="lng"]');
                            console.log('Estrat√©gia 2 - Sections com typed-key-path:', { latSection, lngSection });
                            
                            if (latSection && lngSection) {
                                latInput = latSection.querySelector('input');
                                lngInput = lngSection.querySelector('input');
                            }
                        }
                        
                        // Estrat√©gia 3: Buscar todos os inputs e identificar pelo label
                        if (!latInput || !lngInput) {
                            console.log('Estrat√©gia 3 - Buscando por labels');
                            const allSections = document.querySelectorAll('section[role="group"]');
                            
                            allSections.forEach((section, idx) => {
                                const header = section.querySelector('h4');
                                if (header) {
                                    const text = header.textContent.trim().toLowerCase();
                                    console.log(`Section ${idx}: "${text}"`);
                                    
                                    if (text === 'latitude') {
                                        latInput = section.querySelector('input');
                                    }
                                    if (text === 'longitude') {
                                        lngInput = section.querySelector('input');
                                    }
                                }
                            });
                        }
                        
                        
                        if (latInput && lngInput) {
                            const latValue = parseFloat(lat).toFixed(6);
                            const lngValue = parseFloat(lon).toFixed(6);
                            
                            console.log('Preenchendo com:', { latValue, lngValue });
                            
                            const updateField = (input, value) => {
                                // Focar no campo primeiro
                                input.focus();
                                
                                // Selecionar todo o conte√∫do
                                input.select();
                                
                                // Limpar o campo
                                input.value = '';
                                
                                input.dispatchEvent(new Event('input', { bubbles: true }));
                                
                                return new Promise(resolve => {
                                    setTimeout(() => {
                                        input.value = value;
                                        input.setAttribute('value', value);
                                        
                                        input.dispatchEvent(new Event('input', { bubbles: true }));
                                        input.dispatchEvent(new Event('change', { bubbles: true }));
                                        input.dispatchEvent(new Event('blur', { bubbles: true }));
                                        
                                        // Remover foco
                                        input.blur();
                                        
                                        resolve();
                                    }, 100);
                                });
                            };
                            
                            updateField(latInput, latValue)
                                .then(() => {
                                    return updateField(lngInput, lngValue);
                                })
                                .then(() => {
                                    setTimeout(() => {
                                        enderecoInput.focus();
                                    }, 200);
                                    
                                    showStatus(`‚úÖ Coordenadas preenchidas! Latitude: ${latValue}, Longitude: ${lngValue}`, 'success');
                                })
                                .catch(err => {
                                    console.error('Erro ao atualizar campos:', err);
                                    showStatus('‚ö†Ô∏è Coordenadas preenchidas, mas pode ser necess√°rio verificar.', 'error');
                                });
                        } else {
                            showStatus('‚ùå Inputs de coordenadas n√£o encontrados.', 'error');
                            console.error('N√£o foi poss√≠vel encontrar os campos ap√≥s todas as estrat√©gias');
                        }
                    } else {
                        showStatus('‚ùå Endere√ßo n√£o encontrado. Tente ser mais espec√≠fico ou verifique a ortografia.', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao buscar coordenadas:', error);
                    showStatus('‚ùå Erro ao buscar coordenadas. Verifique sua conex√£o e tente novamente.', 'error');
                } finally {
                    button.disabled = false;
                    button.textContent = 'üåç Buscar Coordenadas Automaticamente';
                }
            });
            
            function showStatus(message, type) {
                statusDiv.textContent = message;
                statusDiv.className = 'geocode-status geocode-' + type;
                statusDiv.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 8000);
                }
            }
            
            buttonContainer.appendChild(button);
            buttonContainer.appendChild(statusDiv);
            
            // Inserir logo ap√≥s a section do endere√ßo
            enderecoSection.parentElement.insertBefore(buttonContainer, enderecoSection.nextSibling);
        }
    </script>
</body>
</html>