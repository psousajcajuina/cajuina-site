---
import type { GetStaticPaths, InferGetStaticPropsType } from 'astro';
import merge from 'lodash.merge';
import { twMerge } from 'tailwind-merge';
import { getCanonical, getPermalink } from '@/utils/permalinks';
import { fetchPages, getStaticPathspages } from '@/utils/pages';
import { blogListRobots } from '@/utils/blog';
import type { MetaData, Page } from '@/types';
import StaticPageLayout from '@/layouts/StaticPageLayout.astro';

import { ChevronRight } from '@lucide/astro';

export const prerender = true;

const pages = await fetchPages();

export const getStaticPaths = (async () => {
  return await getStaticPathspages();
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { page } = Astro.props as Props;

const url = getCanonical(getPermalink(page.permalink, 'pages'));
// Valores padr√£o baseados no post
const defaultMetadata = {
  title: page.title,
  description: page.description,
  canonical: url,
  robots: {
    index: blogListRobots?.index ?? true,
    follow: blogListRobots?.follow ?? true,
  },
  openGraph: {
    url: url,
    type: 'webpage',
    locale: 'pt_BR',
  },
  twitter: {
    cardType: 'summary_large_image',
  },
};

const metadata = merge(defaultMetadata, page?.metadata || {}) as MetaData;
---
<StaticPageLayout metadata={metadata}>
  <section
    class="grid w-full grid-cols-1 gap-2 md:p-20 pt-16! pb-12 md:grid-cols-[minmax(0,280px)_1fr]"
  >
    <div
      id="sidebar-container"
      class="bg-caju-heading-primary relative! h-full w-full b-black"
    >
      <div
        id="sidebar-content"
        class="font-inter top-40 fixed max-w-[300px] mx-4 py-5 text-2xl"
      >
        <ul class="not-prose w-full space-y-3 text-lg">
          {
            pages.map((page: Page) => (
              <li
                class='flex items-center gap-2',
              >
                <a
                  class:list={[
                    "hover:text-caju-heading-orange! hover:scale-105 hover:underline flex items-center", 
                ]}
                  href={`/empresa/${page.permalink}/`}
                  title={page.title}
                >
                  <ChevronRight class="min-size-4" />
                  <span class="truncate flex-1 max-w-52">{page.title}</span>
                </a>
              </li>
            ))
          }
        </ul>
      </div>
    </div>
    <div
      class={twMerge(
        'flex flex-col md:gap-10',
        'font-inter prose prose-lg prose-md prose-headings:font-heading prose-headings:leading-tighter prose-headings:tracking-tighter prose-headings:font-bold prose-a:text-blue-600 prose-img:rounded-md prose-img:shadow-lg max-w-4xl',
        'px-2 pt-8',
        'page-content',
      )}
    >
    <h1 class="font-heading! text-caju-heading-primary! text-3xl font-bold tracking-tighter md:text-5xl">{page.title}</h1>
      {
        page.Content ? (
          <page.Content />
        ) : (
          <Fragment set:html={page.content || ''} />
        )
      }
    </div>
  </section>
</StaticPageLayout>

<script>
  function initSidebar() {
    const container = document.getElementById('sidebar-container');
    const content = document.getElementById('sidebar-content');

    if (!container || !content) return;

    const handleScroll = () => {
      const containerRect = container.getBoundingClientRect();
      const contentHeight = content.offsetHeight;
      // 10rem = 160px (assuming 16px root). Adjust if necessary or compute dynamically.
      // Getting the computed top value if it's fixed might be safer, but hardcoded 160 matches 'top-40'
      const topOffset = 160;

      // The point where the sidebar (if fixed) would touch the bottom of the container
      // Container bottom relative to viewport needs to be greater than sidebar bottom relative to viewport
      const sidebarBottomLimit = topOffset + contentHeight;

      // Added a small buffer (e.g., 20px) to prevent flickering or tight fits
      if (containerRect.bottom < sidebarBottomLimit + 20) {
        // We reached the bottom
        content.classList.remove('fixed', 'top-40');
        content.classList.add('absolute', 'bottom-0');
      } else {
        // We are scrolling freely
        content.classList.add('fixed', 'top-40');
        content.classList.remove('absolute', 'bottom-0');
      }
    };

    window.addEventListener('scroll', handleScroll);
    window.addEventListener('resize', handleScroll);
    handleScroll(); // Initial check
  }

  // Run on load
  initSidebar();

  // Run on view transitions if enabled
  document.addEventListener('astro:page-load', initSidebar);
</script>
