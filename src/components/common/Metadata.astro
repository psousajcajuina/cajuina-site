---
import merge from 'lodash.merge';
import { AstroSeo } from '@astrolib/seo';
import { Schema } from 'astro-seo-schema';

import type { Props as AstroSeoProps } from '@astrolib/seo';

import { SITE, METADATA, I18N } from 'astrowind:config';
import type { MetaData } from '@/types';
import { getCanonical } from '@/utils/permalinks';

import { adaptOpenGraphImages } from '@/utils/images';

import ldJsonImg from '@/assets/images/site/CajuinaTradicional.jpg';
import {
  astroAssetsOptimizer,
  getImagesOptimized,
} from '@/utils/images-optimization';
const image = await getImagesOptimized(ldJsonImg, {}, astroAssetsOptimizer);

// Garante URL absoluta com hostname
const getAbsoluteImageUrl = (imgSrc: string, site?: URL) => {
  if (imgSrc.startsWith('http://') || imgSrc.startsWith('https://')) {
    return imgSrc;
  }
  const baseUrl = site?.origin || 'https://cajuinasaogeraldo.com.br';
  return `${baseUrl}${imgSrc.startsWith('/') ? '' : '/'}${imgSrc}`;
};

const absoluteImageUrl = getAbsoluteImageUrl(image.src, Astro.site);

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
}

const {
  title,
  ignoreTitleTemplate = false,
  canonical = String(getCanonical(String(Astro.url.pathname))),
  robots = {},
  description,
  openGraph = {},
  twitter = {},
} = Astro.props;

const seoProps: AstroSeoProps = merge(
  {
    title: '',
    titleTemplate: '%s',
    canonical: canonical,
    noindex: true,
    nofollow: true,
    description: undefined,
    openGraph: {
      url: canonical,
      site_name: SITE?.name,
      images: [],
      locale: I18N?.language || 'en',
      type: 'website',
    },
    twitter: {
      cardType: openGraph?.images?.length ? 'summary_large_image' : 'summary',
    },
  },
  {
    title: METADATA?.title?.default,
    titleTemplate: METADATA?.title?.template,
    noindex:
      typeof METADATA?.robots?.index !== 'undefined'
        ? !METADATA.robots.index
        : undefined,
    nofollow:
      typeof METADATA?.robots?.follow !== 'undefined'
        ? !METADATA.robots.follow
        : undefined,
    description: METADATA?.description,
    openGraph: METADATA?.openGraph,
    twitter: METADATA?.twitter,
  },
  {
    title: title,
    titleTemplate: ignoreTitleTemplate ? '%s' : undefined,
    canonical: canonical,
    noindex: typeof robots?.index !== 'undefined' ? !robots.index : undefined,
    nofollow:
      typeof robots?.follow !== 'undefined' ? !robots.follow : undefined,
    description: description,
    openGraph: { url: canonical, ...openGraph },
    twitter: twitter,
  }
);
---

<>
  <AstroSeo
    {...{
      ...seoProps,
      openGraph: await adaptOpenGraphImages(seoProps?.openGraph, Astro.site),
    }}
  />
  <Schema
    item={{
      '@context': 'https://schema.org',
      '@graph': [
        {
          '@type': 'WebPage',
          '@id': 'https://www.cajuinasaogeraldo.com.br/',
          url: 'https://www.cajuinasaogeraldo.com.br/',
          name: 'Cajuína São Geraldo - O tradicional refrigerante de Caju do Nordeste',
          isPartOf: {
            '@id': 'https://cajuinasaogeraldo.com.br/#website',
          },
          primaryImageOfPage: {
            '@id': 'https://www.cajuinasaogeraldo.com.br/#primaryimage',
          },
          image: {
            '@id': 'https://www.cajuinasaogeraldo.com.br/#primaryimage',
          },
          thumbnailUrl: absoluteImageUrl,
          datePublished: '2017-06-14T09:23:16+00:00',
          dateModified: '2025-03-18T14:23:17+00:00',
          description:
            'Refrigerante de Caju São Geraldo, o sabor do nordeste que virou tradição. Conheça nossa história, nossos produtos e muito mais. Acesse agora!',
          breadcrumb: {
            '@id': 'https://www.cajuinasaogeraldo.com.br/#breadcrumb',
          },
          inLanguage: 'pt-BR',
          potentialAction: [
            {
              '@type': 'ReadAction',
              target: ['https://www.cajuinasaogeraldo.com.br/'],
            },
          ],
        },
        {
          '@type': 'ImageObject',
          inLanguage: 'pt-BR',
          '@id': 'https://www.cajuinasaogeraldo.com.br/#primaryimage',
          url: absoluteImageUrl,
          contentUrl: absoluteImageUrl,
          //@ts-expect-error any
          width: 512,
          //@ts-expect-error any
          height: 512,
          caption: 'Logo São Geraldo Tradicional',
        },
        {
          '@type': 'BreadcrumbList',
          '@id': 'https://www.cajuinasaogeraldo.com.br/#breadcrumb',
          itemListElement: [
            {
              '@type': 'ListItem',
              position: 1,
              name: 'Início',
            },
          ],
        },
        {
          '@type': 'WebSite',
          '@id': canonical + '#website',
          url: canonical,
          name: 'Cajuína São Geraldo',
          description: 'O tradicional refrigerante de caju',
          potentialAction: [
            {
              '@type': 'SearchAction',
              target: {
                '@type': 'EntryPoint',
                urlTemplate:
                  'https://cajuinasaogeraldo.com.br/?s={search_term_string}',
              },
              //@ts-expect-error any
              'query-input': {
                '@type': 'PropertyValueSpecification',
                valueRequired: true,
                valueName: 'search_term_string',
              },
            },
          ],
          inLanguage: 'pt-BR',
        },
      ],
    }}
  />
</>
